<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº”åéŸ³å†’éšª Ver 3.5.3</title>
    <style>
        :root { --pink: #FFD1DC; --blue: #BFEAF2; --yellow: #FFF4BD; --text: #5d4037; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: sans-serif; }
        body { margin: 0; padding: 0; background-color: #FFFBFA; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        .nav-header {
            width: 100%; background: white; padding: 5px 15px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--pink); flex-shrink: 0;
        }
        .btn-home { text-decoration: none; background: var(--yellow); padding: 5px 12px; border-radius: 15px; font-weight: bold; border: 2px solid var(--text); font-size: 0.9rem; color: var(--text); }

        .control-panel { width: 100%; padding: 5px; background: #fff; display: flex; flex-direction: column; align-items: center; gap: 5px; flex-shrink: 0; }
        .mode-selector { display: flex; gap: 8px; width: 95%; max-width: 600px; }
        .mode-btn { flex: 1; padding: 8px; border-radius: 10px; border: 2.5px solid var(--pink); background: white; font-weight: bold; font-size: 1.1rem; color: var(--text); }
        .mode-btn.active { background: var(--pink); color: white; }

        .row-selector { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; padding: 5px; }
        .row-btn { padding: 8px 15px; background: white; border: 1.5px solid var(--blue); border-radius: 8px; font-size: 1rem; font-weight: bold; color: var(--text); cursor: pointer; }
        .row-btn.active { background: #64d8ff; color: white; border-color: #0099cc; }

        #main-stage { 
            flex-grow: 1; 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            padding: 20px 0 100px 0; 
        }

        .item-grid { display: grid; gap: 20px; width: 95%; max-width: 1200px; padding: 10px; }
        
        /* èªè­˜æ¨¡å¼æ”¹å› 3 æ¬„ï¼Œè®“åœ–æ›´å¤§ */
        .grid-study { grid-template-columns: repeat(3, 1fr); } 
        /* æ¸¬é©—æ¨¡å¼ç¶­æŒ 4 æ¬„ */
        .grid-quiz { grid-template-columns: repeat(4, 1fr); }

        .game-item.study { display: flex; flex-direction: column; align-items: center; padding: 15px; border-color: var(--pink); box-shadow: 0 6px 0 var(--pink); }
        
        /* åœ–ç‰‡æ”¾å¤§å„ªåŒ– */
        .study-img { width: 100%; max-height: 250px; object-fit: contain; border-radius: 10px; margin-bottom: 15px; }
        .study-kana { font-size: 2.8rem; font-weight: bold; color: var(--text); }
        .study-roma { font-size: 1.2rem; color: #999; }

        .game-item {
            background: white; border-radius: 15px; border: 3px solid var(--blue);
            padding: 25px 10px; text-align: center; font-size: 2.2rem;
            font-weight: bold; color: var(--text); box-shadow: 0 5px 0 var(--blue);
            transition: transform 0.1s; cursor: pointer;
        }
        .game-item:active { transform: scale(0.95); }

        .quiz-audio-btn {
            width: 120px; height: 120px; background-color: var(--blue);
            background-image: url('https://fonts.gstatic.com/s/i/short-term/release/googlesymbols/volume_up/default/48px.svg');
            background-size: 60%; background-repeat: no-repeat; background-position: center;
            border-radius: 50%; border: 5px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            cursor: pointer; margin-bottom: 30px; flex-shrink: 0;
        }

        #feedback {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 4rem; font-weight: bold; z-index: 200; pointer-events: none; opacity: 0;
            text-shadow: 2px 2px 0px white;
        }
        .pop-feedback { animation: pop 1.2s ease-out; }
        @keyframes pop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            30% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.2); }
        }
        .version-tag { position: fixed; bottom: 8px; right: 15px; font-size: 12px; opacity: 0.5; font-weight: bold; background: rgba(255,255,255,0.7); padding: 2px 5px; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="nav-header">
        <a href="https://liliancir0125.github.io/Rumi_Study_Hall/" class="btn-home">ğŸ  å›å¤§å»³</a>
        <div style="font-weight: bold; font-size: 1.2rem;">ç­”å°: <span id="correct-count" style="color:#ff8fa3">0</span></div>
    </div>

    <div class="control-panel">
        <div class="mode-selector">
            <button class="mode-btn active" id="btn-study" onclick="setMode('study')">èªè­˜ç·´ç¿’</button>
            <button class="mode-btn" id="btn-quiz" onclick="setMode('quiz')">æŒ‘æˆ°æ¸¬é©—</button>
        </div>
        <div class="row-selector" id="row-btns"></div>
    </div>

    <div id="main-stage"></div>
    <div id="feedback"></div>
    <div class="version-tag">Ver. 3.5.3</div>

    <script>
        const kanaData = {
            'ã‚': [{k:'ã‚', r:'a'},{k:'ã„', r:'i'},{k:'ã†', r:'u'},{k:'ãˆ', r:'e'},{k:'ãŠ', r:'o'}],
            'ã‹': [{k:'ã‹', r:'ka'},{k:'ã', r:'ki'},{k:'ã', r:'ku'},{k:'ã‘', r:'ke'},{k:'ã“', r:'ko'}],
            'ã•': [{k:'ã•', r:'sa'},{k:'ã—', r:'shi'},{k:'ã™', r:'su'},{k:'ã›', r:'se'},{k:'ã', r:'so'}],
            'ãŸ': [{k:'ãŸ', r:'ta'},{k:'ã¡', r:'chi'},{k:'ã¤', r:'tsu'},{k:'ã¦', r:'te'},{k:'ã¨', r:'to'}],
            'ãª': [{k:'ãª', r:'na'},{k:'ã«', r:'ni'},{k:'ã¬', r:'nu'},{k:'ã­', r:'ne'},{k:'ã®', r:'no'}]
        };

        let currentMode = 'study', activeRows = ['ã‚'], correctCount = 0, target = {}, isAnswering = false;

        function speakKana(t) {
            window.speechSynthesis.cancel();
            const ut = new SpeechSynthesisUtterance(t);
            ut.lang = 'ja-JP'; 
            ut.rate = 0.5; 
            window.speechSynthesis.speak(ut);
        }

        function speakSentence(t) {
            const ut = new SpeechSynthesisUtterance(t);
            ut.lang = 'ja-JP'; 
            ut.rate = 1.0; 
            window.speechSynthesis.speak(ut);
        }

        function playSuccessSound() {
            speakSentence("æ­£è§£ã§ã™ï¼ãŠã‚ã§ã¨ã†");
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.type = 'sine'; osc.frequency.setValueAtTime(880, ctx.currentTime);
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            osc.start(); osc.stop(ctx.currentTime + 0.2);
        }

        function setMode(m) {
            currentMode = m;
            document.getElementById('btn-study').classList.toggle('active', m==='study');
            document.getElementById('btn-quiz').classList.toggle('active', m==='quiz');
            render();
        }

        function toggleRow(row) {
            const index = activeRows.indexOf(row);
            if (index > -1) {
                if (activeRows.length > 1) activeRows.splice(index, 1);
            } else {
                activeRows.push(row);
            }
            updateRowBtns(); render();
        }

        function updateRowBtns() {
            const container = document.getElementById('row-btns');
            container.innerHTML = '';
            Object.keys(kanaData).forEach(row => {
                const btn = document.createElement('button');
                btn.className = 'row-btn' + (activeRows.includes(row) ? ' active' : '');
                btn.innerText = row + ' è¡Œ';
                btn.onclick = () => toggleRow(row);
                container.appendChild(btn);
            });
        }

        function render() {
            const stage = document.getElementById('main-stage');
            stage.innerHTML = '';
            stage.scrollTop = 0;
            isAnswering = false;
            let combinedList = [];
            activeRows.forEach(row => { combinedList = combinedList.concat(kanaData[row]); });
            const grid = document.createElement('div');
            grid.className = 'item-grid';

            if (currentMode === 'study') {
                grid.classList.add('grid-study');
                combinedList.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'game-item study';
                    card.innerHTML = `
                        <img src="images/${item.r}.jpg" class="study-img" alt="${item.k}" onerror="this.src='https://via.placeholder.com/150?text=${item.k}'">
                        <div class="study-kana">${item.k}</div>
                        <div class="study-roma">${item.r}</div>
                    `;
                    card.onclick = () => speakKana(item.k);
                    grid.appendChild(card);
                });
                stage.appendChild(grid);
            } else {
                grid.classList.add('grid-quiz');
                target = combinedList[Math.floor(Math.random() * combinedList.length)];
                const audioBtn = document.createElement('div');
                audioBtn.className = 'quiz-audio-btn';
                audioBtn.onclick = () => speakKana(target.k);
                stage.appendChild(audioBtn);
                setTimeout(() => speakKana(target.k), 300);

                let options = [target];
                let others = combinedList.filter(i => i.k !== target.k);
                others.sort(() => Math.random() - 0.5);
                options = options.concat(others.slice(0, 3));
                options.sort(() => Math.random() - 0.5);

                options.forEach(item => {
                    const btn = document.createElement('div');
                    btn.className = 'game-item';
                    btn.innerText = item.k;
                    btn.onclick = () => checkAnswer(item.k);
                    grid.appendChild(btn);
                });
                stage.appendChild(grid);
            }
        }

        function showFeedback(text, color) {
            const fb = document.getElementById('feedback');
            fb.innerText = text; fb.style.color = color;
            fb.className = 'pop-feedback';
            setTimeout(() => fb.className = '', 1200);
        }

        function checkAnswer(kana) {
            if (isAnswering) return;
            if (kana === target.k) {
                isAnswering = true;
                correctCount++;
                document.getElementById('correct-count').innerText = correctCount;
                showFeedback("â­ ç­”å°äº†ï¼", "#77dd77");
                playSuccessSound();
                setTimeout(render, 2500);
            } else {
                showFeedback("âŒ å†è©¦ä¸€æ¬¡", "#ff6961");
                speakSentence("ã¡ãŒã†"); 
            }
        }

        window.onload = () => { updateRowBtns(); render(); };
    </script>
</body>
</html>
